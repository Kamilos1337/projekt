<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <!-- ios support -->
    <link rel="apple-touch-icon" href="images/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="images/icons/icon-96x96.png">
    <link rel="apple-touch-icon" href="images/icons/icon-128x128.png">
    <link rel="apple-touch-icon" href="images/icons/icon-144x144.png">
    <link rel="apple-touch-icon" href="images/icons/icon-152x152.png">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="images/icons/icon-384x384.png">
    <link rel="apple-touch-icon" href="images/icons/icon-512x512.png">
    <meta name="apple-mobile-web-app-status-bar" content="#db4938">
    <meta name="theme-color" content="#db4938">

    <title>Kurier app</title>
  </head>
  <body>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <main>
      <nav>
        <h1>Kurier'App</h1>
        <ul>
          <li><a type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a></li>

        </ul>
      </nav>

      <div class="modal" id="loginModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Logowanie</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-left">
        <form>
        <div class="mb-3">

          <input type="email" class="form-control" placeholder="Login" id="login" aria-describedby="emailHelp">
        </div>
        <div class="mb-3">
          <input type="password" class="form-control" placeholder="Hasło" id="pass">
        </div>


    </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
        <button type="button" class="btn btn-primary" onclick="login(document.querySelector('#login').value, document.querySelector('#pass').value)">Zaloguj się</button>
      </div>
    </div>
  </div>
</div>
    <h2 id="user"></h2>

    <h2>Lista paczek:</h2>

      <div class="container"></div>
    </main>



    <script src="js/app.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Firestore

        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'
        import { collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAoyx-GPeLViIx6-2HRfxC-atMLXxAHuwA",
          authDomain: "studia-46c56.firebaseapp.com",
          projectId: "studia-46c56",
          storageBucket: "studia-46c56.appspot.com",
          messagingSenderId: "266129178736",
          appId: "1:266129178736:web:d5b01218cb3ae90f1f74b5",
          measurementId: "G-VK6WYZ8YGD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Initialize Cloud Firestore and get a reference to the service
        const db = getFirestore(app);

        // Read data
        const users = await getDocs(collection(db, "users"));

        function setCookie(name,value,days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }
        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }
        if(getCookie("login")){
                document.querySelector("#user").innerHTML = "Witamy: "+ getCookie("name")
        }

        function eraseCookie(name) {
            document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }
        const login = async (login,password) =>{
            console.log(login,password)
            const q = query(collection(db, "users"), where("login", "==", login), where("password", "==", password));
            const querySnapshot = await getDocs(q);
            let status = false;;
            await querySnapshot.forEach((doc) => {
              // doc.data() is never undefined for query doc snapshots
              setCookie("login", doc.id, 30)
              setCookie("name", doc.data().login, 30)
              console.log(doc.id, " => ", doc.data());
              status = true;
            })
            if(status){
              alert("Udało się zalogować")
            }else{
              alert("Podane dane są niepoprawne")
            }
        }

        window.login=login
        // querySnapshot.forEach((doc) => {
        //     console.log(doc.data());
        //     console.log(doc.data()['brand'],doc.data()['model']);
        //     document.writeln(doc.data()['brand'],' ',doc.data()['model'],'<br>');
        // });
        const showCoffees = async () => {
          let output = "";
          const q = query(collection(db, "delivery"), where("user_id", "==", getCookie("login")));
          const querySnapshot = await getDocs(q);
          await querySnapshot.forEach((doc) => {
            // doc.data() is never undefined for query doc snapshots
            output += `
              <div class="card" style="width: 18rem;">
                <img class="card--avatar" src="/images/coffe1.png" />
              <div class="card-body">
                <h5 class="card-title">${doc.data().title}</h5>
                <p class="card-text"><b>${doc.data().size}</b></p>
                <a href="#" class="btn btn-primary">Wczytujemy kawy... :)</a>
              </div>
            </div>
                        `
          })

          document.querySelector(".container").innerHTML = output;
        };
        showCoffees()
        document.addEventListener("DOMContentLoaded", showCoffees);
    </script>
  </body>
</html>
